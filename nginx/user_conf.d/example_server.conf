server {
  # Listen to port 443 on both IPv4 and IPv6.
  listen 443 ssl default_server reuseport;
  listen [::]:443 ssl default_server reuseport;

  # Domain names this server should respond to.
  server_name example.com;

  # Load the certificate files.
  ssl_certificate /etc/letsencrypt/live/test-name/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/test-name/privkey.pem;
  ssl_trusted_certificate /etc/letsencrypt/live/test-name/chain.pem;

  # Load the Diffie-Hellman parameter.
  ssl_dhparam /etc/letsencrypt/dhparams/dhparam.pem;

  location /portainer/ {
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    set $upstream_portainer portainer;
    proxy_pass https://$upstream_portainer:9443/;
  }

  location /portainer/api/websocket/ {
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_http_version 1.1;
    set $upstream_portainer portainer;
    proxy_pass https://$upstream_portainer:9443/api/websocket/;
  }

  location /gitlab/ {
    proxy_set_header Host $http_host;
    set $upstream_gitlab gitlab;
    proxy_pass https://$upstream_gitlab/gitlab/;
  }

  location /xwiki/ {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $host;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_cache_bypass $http_upgrade;
    set $upstream_xwiki xwiki;
    proxy_pass http://$upstream_xwiki:8080/xwiki/;
  }
}
